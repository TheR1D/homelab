## template: jinja
#cloud-config

merge_how:
 - name: list
   settings: [append]
 - name: dict
   settings: [no_replace, recurse_list]

packages:
  - postgresql
  - postgresql-contrib
  - certbot
  - python3-certbot-dns-cloudflare

write_files:
  - path: /etc/kong/kong.conf
    permissions: "0644"
    content: |
      # Kong configuration
      database = postgres
      pg_host = 127.0.0.1
      pg_port = 5432
      pg_user = kong
      pg_password = kong
      pg_database = kong

      # Admin API (bind to all interfaces for Terraform management)
      admin_listen = 0.0.0.0:8001, 0.0.0.0:8444 ssl

      # Proxy listeners with SSL certificates
      proxy_listen = 0.0.0.0:80, 0.0.0.0:443 ssl
      ssl_cert = /etc/kong/ssl/fullchain.pem
      ssl_cert_key = /etc/kong/ssl/privkey.pem

      # Status endpoint for health checks
      status_listen = 0.0.0.0:8100

  - path: /etc/letsencrypt/cloudflare.ini
    permissions: "0600"
    content: |
      dns_cloudflare_api_token = ${cf_api_token}

  - path: /usr/local/bin/kong-cert-renew
    permissions: "0755"
    content: |
      #!/bin/bash
      # Renew certificates and reload Kong
      certbot renew --quiet
      # Update Kong SSL symlinks
      cp -L /etc/letsencrypt/live/${cert_domain}/fullchain.pem /etc/kong/ssl/fullchain.pem
      cp -L /etc/letsencrypt/live/${cert_domain}/privkey.pem /etc/kong/ssl/privkey.pem
      # Reload Kong to pick up new certs
      kong reload -c /etc/kong/kong.conf 2>/dev/null || true

  - path: /etc/cron.d/kong-cert-renew
    permissions: "0644"
    content: |
      0 0,12 * * * root /usr/local/bin/kong-cert-renew

runcmd:
  # Setup PostgreSQL for Kong
  - sudo -u postgres psql -c "CREATE USER kong WITH PASSWORD 'kong';"
  - sudo -u postgres psql -c "CREATE DATABASE kong OWNER kong;"

  # Install Kong Gateway via package manager (latest 3.13.x)
  - curl -1sLf "https://packages.konghq.com/public/gateway-313/gpg.B3A98B904066BD1F.key" | gpg --dearmor | tee /usr/share/keyrings/kong-gateway-313-archive-keyring.gpg > /dev/null
  - curl -1sLf "https://packages.konghq.com/public/gateway-313/config.deb.txt?distro=ubuntu&codename=noble" | tee /etc/apt/sources.list.d/kong-gateway-313.list > /dev/null
  - apt-get update
  - apt-get install -y kong-enterprise-edition=3.13.0.1

  # Create Kong directories
  - mkdir -p /etc/kong
  - mkdir -p /etc/kong/ssl

  # Obtain SSL certificate via DNS-01 challenge (Cloudflare)
  # Kong ACME plugin doesn't support DNS-01 challenges ðŸ¤·â€â™‚ï¸
  # TODO: Remove staging after alpha testing
  - |
    certbot certonly \
      --staging \
      --dns-cloudflare \
      --dns-cloudflare-credentials /etc/letsencrypt/cloudflare.ini \
      --email "${cert_email}" \
      --agree-tos \
      --no-eff-email \
      -d "${cert_domain}" \
      -d "*.${cert_domain}"

  # Copy certificates to Kong SSL directory
  - cp -L /etc/letsencrypt/live/${cert_domain}/fullchain.pem /etc/kong/ssl/fullchain.pem
  - cp -L /etc/letsencrypt/live/${cert_domain}/privkey.pem /etc/kong/ssl/privkey.pem
  - chmod 644 /etc/kong/ssl/fullchain.pem
  - chmod 600 /etc/kong/ssl/privkey.pem

  # Run Kong migrations
  - kong migrations bootstrap -c /etc/kong/kong.conf

  # Start Kong
  - kong start -c /etc/kong/kong.conf

  # Setup Kong to start on boot (runs as root to access SSL certs)
  - |
    cat > /etc/systemd/system/kong.service << 'EOFSERVICE'
    [Unit]
    Description=Kong API Gateway
    After=network.target postgresql.service
    Requires=postgresql.service

    [Service]
    Type=forking
    ExecStart=/usr/local/bin/kong start -c /etc/kong/kong.conf
    ExecReload=/usr/local/bin/kong reload -c /etc/kong/kong.conf
    ExecStop=/usr/local/bin/kong stop
    Restart=on-failure

    [Install]
    WantedBy=multi-user.target
    EOFSERVICE
  - sed -i 's/^    //' /etc/systemd/system/kong.service
  - systemctl daemon-reload
  - systemctl enable kong

  # Firewall rules
  # Admin API (restrict to local network)
  - ufw allow from ${local_subnet} to any port 8001 proto tcp
  - ufw allow from ${local_subnet} to any port 8444 proto tcp
  # Proxy ports (public access)
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  # Status endpoint (health checks)
  - ufw allow from ${local_subnet} to any port 8100 proto tcp
  - ufw --force enable
  - reboot
